name: Deploy to Production (Releases)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Release Timestamp
        id: vars
        run: echo "release=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Prepare release directory
        run: |
          ssh root@192.168.1.192 "mkdir -p /var/www/prod/releases/${{ steps.vars.outputs.release }}"
          ssh root@192.168.1.192 "mkdir -p /var/www/prod/shared/storage"
          ssh root@192.168.1.192 "mkdir -p /var/www/prod/shared/bootstrap/cache"

      - name: Upload application code to release
        run: |
          rsync -avz --delete \
            --exclude ".env" \
            --exclude "vendor" \
            --exclude "node_modules" \
            ./ root@192.168.1.192:/var/www/prod/releases/${{ steps.vars.outputs.release }}/

      - name: Symlink shared storage and .env
        run: |
          ssh root@192.168.1.192 "ln -nfs /var/www/prod/shared/.env /var/www/prod/releases/${{ steps.vars.outputs.release }}/.env"
          ssh root@192.168.1.192 "rm -rf /var/www/prod/releases/${{ steps.vars.outputs.release }}/storage"
          ssh root@192.168.1.192 "ln -nfs /var/www/prod/shared/storage /var/www/prod/releases/${{ steps.vars.outputs.release }}/storage"

      - name: Install dependencies
        run: |
          ssh root@192.168.1.192 "
            cd /var/www/prod/releases/${{ steps.vars.outputs.release }} &&
            composer install --no-interaction --prefer-dist --no-dev
          "

      - name: Run migrations and clear cache
        run: |
          ssh root@192.168.1.192 "
            cd /var/www/prod/releases/${{ steps.vars.outputs.release }} &&
            php artisan migrate --force &&
            php artisan config:clear &&
            php artisan route:clear &&
            php artisan cache:clear
          "

      - name: Update current symlink (switch release)
        run: |
          ssh root@192.168.1.192 "
            rm -rf /var/www/prod/current &&
            ln -nfs /var/www/prod/releases/${{ steps.vars.outputs.release }} /var/www/prod/current
          "
      - name: Restart PHP-FPM & Nginx
        run: |
          ssh root@192.168.1.192 "systemctl restart php-fpm && systemctl restart nginx"

      - name: Keep last 3 releases
        run: |
          ssh root@192.168.1.192 "cd /var/www/prod/releases && ls -1t | tail -n +4 | xargs -I {} rm -rf {}"
